# Department of Agriculture Tap Page

## Overview

This application is accessed by people tapping the NFC chip inside their Department of Agriculture hat. In doing so, they will land on the index route, and from there we will perform 2 checks:

1. Is their tap valid?
- We do this by hitting the `GET /refs/:id` endpoint from the IYK API with `iykRef` query parameter.
  - This will return a JSON response with 3 properties we care about: `isValidRef`, `uid`, and `otp` (an object containing a `code` property).
  - If `isValidRef` is `false`, redirect the user to a "tap-invalid" page.
  - If `isValidRef` is `true`, we will continue to the next check.
  - `uid` is the unique identifier for the chip.
  - Documentation for this endpoint can be found at https://docs.iyk.app/api-core/refs, and no API key is needed.

2. Is the reward period active?
- The reward period is active for 10 minutes on Friday (Eastern time) every week, and is triggered by an admin.
- If the reward period is not active, redirect the user to a "reward-not-active" page.
- If the reward is active and the current chip has not claimed for this week yet, redirect the user to a "reward-active-unclaimed" page.
- If the reward is active and the current chip has already claimed for this week, redirect the user to a "reward-claimed-active" page.

## Pages

- `/` (index): The main page where users will be redirected to after tapping their chip.
- `tap-invalid`: The tap was invalid.
- `tap-unauthorized`: The tap was valid but the chip is not authorized (not in our database).
- `reward-not-active`: The reward period is not active.
- `reward-active-unclaimed`: The reward period is active and the chip has not claimed for this week yet.
- `reward-claimed-active`: The reward period is active and the chip has already claimed for this week.
- `reward-claimed-inactive`: The reward period has passed and the chip has already claimed for this week.
- `admin`: A password gated page for the admin to start the 10-minute reward period.

## Authentication Flow

The user should not be able to navigate to any of the pages prefixed with `reward` unless they came from a valid tap in the current session. We do this by:

1. Validating the `iykRef` on the server in the index page
2. Checking if the chip UID exists in our database (authorization)
3. Setting a cookie with the OTP code via a dedicated API route
4. Using middleware to protect all reward pages

Whenever the user accesses one of the reward pages, they are redirected to the index page if they do not have a valid OTP cookie. We check the OTP validity with `GET /otps/:id` from the IYK API, which returns `isExpired` and `uid`. We use this to validate the user is on the correct page based on the state of the chip.

## Reward Claiming Process

When a user with a valid tap visits the reward-active-unclaimed page:

1. They must enter their Ethereum wallet address
2. The wallet address is validated (basic format check)
3. The claim is recorded in the database with:
   - The chip ID
   - The reward period ID
   - The wallet address
   - The claim timestamp

This information will be used to distribute rewards when the current reward period ends.

## Database

We use Supabase to store the data with the following tables:

- `chips`: Tracks NFC chip UIDs and their last tap timestamp
- `reward_periods`: Tracks when reward periods start and end
- `claims`: Records which chips claimed rewards in which periods, including wallet addresses
- `admins`: Manages access to the admin page

We use Supabase's autogenerated TypeScript types for type safety and consistency.

## Completed Items

- Basic application structure and routing
- IYK API integration for tap validation
- OTP-based authentication flow
- Middleware protection for reward pages
- Reward period management
- Chip authorization checks
- Wallet address collection for reward claims
- Database integration with Supabase
- Type safety with autogenerated database types

## Assorted TODOs

- Review cookie lifetime for storing OTP
- Implement proper password authentication for the admin page
- Connect wallet + sign message to authenticate user for claiming reward (and use Viem on the backend to validate the address + signature)